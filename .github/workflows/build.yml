name: Multi-Platform Build
on:
  push:
    tags:
      - "v*"

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20.14"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.7.1

      - name: Build Windows
        run: wails build -clean -nsis -ldflags='-s -w'

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            build/bin/nf-disk-amd64-installer.exe
            build/bin/nf-disk.exe

  build-darwin-arm:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20.14"

      - name: Install Wails
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.7.1
          
      - name: Install create-dmg (for DMG packaging)
        run: |
          brew install create-dmg

      - name: Build macOS ARM
        run: |
          wails build -clean -platform darwin/arm64 -ldflags='-s -w' -o nf-disk-arm64

      - name: Create DMG installer
        run: |
          cd build/bin
          create-dmg \
            --volname "nf-disk Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            nf-disk-arm64-installer.dmg \
            nf-disk-arm64.app

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: darwin-arm-binaries
          path: |
            build/bin/nf-disk-arm64.app
            build/bin/nf-disk-arm64-installer.dmg

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-darwin-arm]
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: release-artifacts

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: darwin-arm-binaries
          path: release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          files: |
            release-artifacts/*